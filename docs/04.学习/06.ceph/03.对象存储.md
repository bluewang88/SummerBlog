---
title: 对象存储
date: 2021-03-30 14:40:00
permalink: /pages/912991/
categories:
  - 学习
  - ceph
tags:
  - ceph
---



radosgw 是 RADOS 对象存储的一个 HTTP REST 网关，是 Ceph 分布式存储系统的一部分。它是用 libfcgi 实现的一个 FastCGI 模块，可联合任何支持 FastCGI 功能的网页服务器使用。

<!-- more -->





## radosgw状态查看


```
[root@summer ~]# /bin/systemctl  start radosgw
[root@summer ~]# service ceph-radosgw status
/bin/radosgw is running.
```


```
root in summer in /proc/927201 
❯ systemctl status ceph-radosgw.service
● ceph-radosgw.service - LSB: radosgw RESTful rados gateway
   Loaded: loaded (/etc/rc.d/init.d/ceph-radosgw; bad; vendor preset: disabled)
   Active: active (exited) since Sat 2021-05-08 09:29:44 CST; 2 days ago
     Docs: man:systemd-sysv-generator(8)
  Process: 927135 ExecStart=/etc/rc.d/init.d/ceph-radosgw start (code=exited, status=0/SUCCESS)
    Tasks: 0
   Memory: 0B

May 08 09:29:43 summer systemd[1]: Starting LSB: radosgw RESTful rados gateway...
May 08 09:29:43 summer ceph-radosgw[927135]: Starting radosgw instance(s)...
May 08 09:29:43 summer ceph-radosgw[927135]: Running as unit run-927185.service.
May 08 09:29:43 summer ceph-radosgw[927135]: Starting client.radosgw.gateway...
May 08 09:29:44 summer ceph-radosgw[927135]: /bin/radosgw is running.
May 08 09:29:44 summer systemd[1]: Started LSB: radosgw RESTful rados gateway.
root in summer in /proc/927201 
➜ cd /etc/rc.d/init.d/
root in summer in /etc/rc.d/init.d 
➜ ll
total 80
-rw-r--r--  1 root root 18281 Mar 29  2019 functions
-rwxr-xr-x  1 root root  4569 Mar 29  2019 netconsole
-rwxr-xr-x  1 root root  9193 Mar 13  2020 network
-rwxr-xr-x  1 root root  3148 Apr 22 16:27 rbdmap
-rw-r--r--  1 root root  1160 Nov 11 23:39 README
-rwxr-xr-x. 1 root root  2437 Feb  6  2018 rhnsd
-rwxr-xr-x  1 root root 13829 Apr 22 16:27 ceph
-rwxr-xr-x  1 root root  2841 Apr 22 16:27 ceph-radosgw
-rwxr-xr-x  1 root root  1721 Mar  1 13:59 sshd
-rwxr-xr-x  1 root root  3783 Dec 24  2018 tgtd
root in summer in /etc/rc.d/init.d 
➜ ./ceph-radosgw 
functions     netconsole    network       rbdmap        README        rhnsd         ceph          ceph-radosgw  sshd          tgtd          
root in summer in /etc/rc.d/init.d 
➜ ./ceph-radosgw -h
Usage: ./ceph-radosgw {start|stop|restart|force-reload|reload|status} [-v|--verbose]
root in summer in /etc/rc.d/init.d 
❯ ./ceph-radosgw status
/bin/radosgw is running.
root in summer in /etc/rc.d/init.d 
➜
```



## 用户
### 创建用户

```
root in summer in ~ via 🐍 v2.7.5 took 3s 
❯ radosgw-admin user create --uid="summerKing" --display-name="summerKing" --access-key=q88888888 --secret=q88888888 --op_mask=read,write,delete --email=qweer@qq.com
{
    "user_id": "summerKing",
    "display_name": "summerKing",
    "email": "qweer@qq.com",
    "suspended": 0,
    "max_buckets": 1000,
    "auid": 0,
    "subusers": [],
    "keys": [
        {
            "user": "summerKing",
            "access_key": "q88888888",
            "secret_key": "q88888888"
        }
    ],
    "swift_keys": [],
    "caps": [],
    "op_mask": "read, write, delete",
    "default_placement": "",
    "placement_tags": [],
    "bucket_quota": {
        "enabled": false,
        "check_on_raw": false,
        "max_size": -1,
        "max_size_kb": -1,
        "max_objects": -1
    },
    "user_quota": {
        "enabled": false,
        "check_on_raw": false,
        "max_size": -1,
        "max_size_kb": -1,
        "max_objects": -1
    },
    "temp_url_keys": [],
    "mfa_ids": []
}

root in summer in ~ via 🐍 v2.7.5 
➜
```

### 查看所有用户user


```
root in iscloud163-200 in ~ via 🐍 v2.7.5 
➜ radosgw-admin metadata list user
[
    "summerKing"

]
```

### 查看用户信息

```
root in summer in ~ via 🐍 v2.7.5 took 3s 
➜ radosgw-admin user info --uid=summerKing
{
    "user_id": "summerKing",
    "display_name": "summerKing",
    "email": "qweer@qq.com",
    "suspended": 0,
    "max_buckets": 1000,
    "auid": 0,
    "subusers": [],
    "keys": [
        {
            "user": "summerKing",
            "access_key": "q88888888",
            "secret_key": "q88888888"
        }
    ],
    "swift_keys": [],
    "caps": [],
    "op_mask": "read, write, delete",
    "default_placement": "",
    "placement_tags": [],
    "bucket_quota": {
        "enabled": false,
        "check_on_raw": false,
        "max_size": -1,
        "max_size_kb": -1,
        "max_objects": -1
    },
    "user_quota": {
        "enabled": false,
        "check_on_raw": false,
        "max_size": -1,
        "max_size_kb": -1,
        "max_objects": -1
    },
    "temp_url_keys": [],
    "mfa_ids": []
}


```

### 修改用户信息

```
root in summer in ~ via 🐍 v2.7.5 
➜ radosgw-admin user modify --uid=xsw --display-name="xswgogogo" --email=1111111@qq.com
{
    "user_id": "xsw",
    "display_name": "xswgogogo",
    "email": "1111111@qq.com",
    "suspended": 0,
    "max_buckets": 1000,
    "auid": 0,
    "subusers": [],
    "keys": [
        {
            "user": "xsw",
            "access_key": "q1234567",
            "secret_key": "q1234567"
        }
    ],
    "swift_keys": [],
    "caps": [],
    "op_mask": "read, write, delete",
    "default_placement": "",
    "placement_tags": [],
    "bucket_quota": {
        "enabled": true,
        "check_on_raw": false,
        "max_size": 2048,
        "max_size_kb": 2,
        "max_objects": 2048
    },
    "user_quota": {
        "enabled": true,
        "check_on_raw": false,
        "max_size": 1024,
        "max_size_kb": 1,
        "max_objects": 1024
    },
    "temp_url_keys": [],
    "mfa_ids": []
}
```



### 删除用户

```
root in summer in ~ via 🐍 v2.7.5 
➜ radosgw-admin user rm --uid=summerKing
```

### 设置用户配额

- Bucket: 选项 --bucket 允许你为用户的某一个 bucket 设置配额。
- Maximum Objects: 选项 --max-objects 允许你设置最大对象数。负数表示不启用这个设置。
- Maximum Size: 选项 --max-size 允许你设置一个最大存储用量的配额。负数表示不启用这个设置。
- Quota Scope: 选项 --quota-scope 表示这个配额 生效的范围。这个参数的值是 bucket 和 user. Bucket 配额作用于用户的某一个 bucket。而用户配额作用于一个用户。

```
root in summer in ~ via 🐍 v2.7.5 took 4s 
➜ radosgw-admin quota set --quota-scope=user --uid=xsw --max-objects=1024 --max-size=1024
root in summer in ~ via 🐍 v2.7.5 
➜ radosgw-admin user info --uid=xsw 
{
    "user_id": "xsw",
    "display_name": "xsw777",
    "email": "qw777e@qq.com",
    "suspended": 0,
    "max_buckets": 1000,
    "auid": 0,
    "subusers": [],
    "keys": [
        {
            "user": "xsw",
            "access_key": "q1234567",
            "secret_key": "q1234567"
        }
    ],
    "swift_keys": [],
    "caps": [],
    "op_mask": "read, write, delete",
    "default_placement": "",
    "placement_tags": [],
    "bucket_quota": {
        "enabled": true,
        "check_on_raw": false,
        "max_size": -1,
        "max_size_kb": -1,
        "max_objects": -1
    },
    "user_quota": {
        "enabled": false,
        "check_on_raw": false,
        "max_size": 1024,
        "max_size_kb": 1,
        "max_objects": 1024
    },
    "temp_url_keys": [],
    "mfa_ids": []
}
```



### 启用用户配额
- 最大对象数和最大存储用量的值是负数则表示不启用指定的配额参数。

```
root in summer in ~ via 🐍 v2.7.5 took 3s 
➜ radosgw-admin quota enable --quota-scope=user --uid=xsw
root in summer in ~ via 🐍 v2.7.5 took 3s 
➜ radosgw-admin user info --uid=xsw
{
    "user_id": "xsw",
    "display_name": "xsw777",
    "email": "qw777e@qq.com",
    "suspended": 0,
    "max_buckets": 1000,
    "auid": 0,
    "subusers": [],
    "keys": [
        {
            "user": "xsw",
            "access_key": "q1234567",
            "secret_key": "q1234567"
        }
    ],
    "swift_keys": [],
    "caps": [],
    "op_mask": "read, write, delete",
    "default_placement": "",
    "placement_tags": [],
    "bucket_quota": {
        "enabled": false,
        "check_on_raw": false,
        "max_size": -1,
        "max_size_kb": -1,
        "max_objects": -1
    },
    "user_quota": {
        "enabled": true,
        "check_on_raw": false,
        "max_size": -1,
        "max_size_kb": -1,
        "max_objects": -1
    },
    "temp_url_keys": [],
    "mfa_ids": []
}
```




## bucket

### 查看系统用所有bucket

```
root in iscloud163-200 in ~ via 🐍 v2.7.5 
➜ radosgw-admin metadata list bucket
[
    "eee"

]
```







### 查看bucket的配额
```
[root@iscloud163-200 conf.d]# radosgw-admin bucket stats --bucket=123
{
    "bucket": "123",
    "tenant": "",
    "pool": "r-_k60sysmag000",
    "index_pool": "r-_k60sysmag000",
    "id": "default.23102.1",
    "marker": "default.23102.1",
    "owner": "ooo",
    "seconds_upload": false,
    "multi_version": false,
    "append_write": false,
    "ver": "0#1,1#17,2#7,3#7",
    "master_ver": "0#0,1#0,2#0,3#0",
    "mtime": "2021-03-26 15:54:26.000000",
    "max_marker": "0#,1#,2#,3#",
    "usage": {
        "rgw.main": {
            "size_kb": 187140,
            "size_kb_actual": 187144,
            "num_objects": 2
        }
    },
    "bucket_quota": {
        "enabled": true,
        "check_on_raw": false,
        "max_size": 10484711424,
        "max_size_kb": 10238976,
        "max_objects": 8888
    }
}
```



### 获取用户已消耗的配额
```
root in summer in ~ via 🐍 v2.7.5 took 3s 
➜ radosgw-admin user stats --uid=xsw
{
    "stats": {
        "total_entries": 17,
        "total_bytes": 131895565,
        "total_bytes_rounded": 131907584
    },
    "last_stats_sync": "2021-05-10 08:31:21.929892Z",
    "last_stats_update": "2021-05-10 08:31:21.927804Z"
}
```



### 设置桶配额


```
root in summer in ~ via 🐍 v2.7.5 took 4s 
➜ radosgw-admin quota set --uid=xsw --quota-scope=bucket --max-objects=2048 --max-size=2048
root in summer in ~ via 🐍 v2.7.5 
➜ radosgw-admin user info --uid=xsw
{
    "user_id": "xsw",
    "display_name": "xsw777",
    "email": "qw777e@qq.com",
    "suspended": 0,
    "max_buckets": 1000,
    "auid": 0,
    "subusers": [],
    "keys": [
        {
            "user": "xsw",
            "access_key": "q1234567",
            "secret_key": "q1234567"
        }
    ],
    "swift_keys": [],
    "caps": [],
    "op_mask": "read, write, delete",
    "default_placement": "",
    "placement_tags": [],
    "bucket_quota": {
        "enabled": false,
        "check_on_raw": false,
        "max_size": 2048,
        "max_size_kb": 2,
        "max_objects": 2048
    },
    "user_quota": {
        "enabled": true,
        "check_on_raw": false,
        "max_size": 1024,
        "max_size_kb": 1,
        "max_objects": 1024
    },
    "temp_url_keys": [],
    "mfa_ids": []
}
```


### 启动桶配额


```
root in summer in ~ via 🐍 v2.7.5 took 3s 
➜ radosgw-admin quota enable --quota-scope=bucket --uid=xsw
root in summer in ~ via 🐍 v2.7.5 took 3s 
➜ radosgw-admin user info --uid=xsw 
{
    "user_id": "xsw",
    "display_name": "xsw777",
    "email": "qw777e@qq.com",
    "suspended": 0,
    "max_buckets": 1000,
    "auid": 0,
    "subusers": [],
    "keys": [
        {
            "user": "xsw",
            "access_key": "q1234567",
            "secret_key": "q1234567"
        }
    ],
    "swift_keys": [],
    "caps": [],
    "op_mask": "read, write, delete",
    "default_placement": "",
    "placement_tags": [],
    "bucket_quota": {
        "enabled": true,
        "check_on_raw": false,
        "max_size": -1,
        "max_size_kb": -1,
        "max_objects": -1
    },
    "user_quota": {
        "enabled": true,
        "check_on_raw": false,
        "max_size": -1,
        "max_size_kb": -1,
        "max_objects": -1
    },
    "temp_url_keys": [],
    "mfa_ids": []
}
```

## 测试S3访问

```python
import boto
import boto.s3.connection

access_key = 'q123123123'
secret_key = 'q123123123'
conn = boto.connect_s3(
        aws_access_key_id = access_key,
        aws_secret_access_key = secret_key,
        host = 'summer', port = 8080,
        is_secure=False, calling_format = boto.s3.connection.OrdinaryCallingFormat(),
        )

bucket = conn.create_bucket('my-new-bucket')
    for bucket in conn.get_all_buckets():
        print "{name}".format(
            name = bucket.name,
            created = bucket.creation_date,
 )
```


```
root in summer in ~ via 🐍 v2.7.5 
❯ pip install boto
Collecting boto
  Downloading https://files.pythonhosted.org/packages/23/10/c0b78c27298029e4454a472a1919bde20cb182dab1662cec7f2ca1dcc523/boto-2.49.0-py2.py3-none-any.whl (1.4MB)
    100% |████████████████████████████████| 1.4MB 418kB/s 
Installing collected packages: boto
Successfully installed boto-2.49.0
You are using pip version 8.1.2, however version 21.1.1 is available.
You should consider upgrading via the 'pip install --upgrade pip' command.
root in summer in ~ via 🐍 v2.7.5 took 7s 
➜ python s3test.py 
my-new-bucket
root in summer in ~ via 🐍 v2.7.5 
❯ radosgw-admin metadata list bucket
[
    "my-new-bucket"

]

```




## 问题


> 桶里的目录为什么不记录大小和修改时间？

 只有对象的概念，目录是虚拟出来的，就是路径分隔
 
> 新建用户失败 

```
root in summer in ~ via 🐍 v2.7.5 took 3s 
❯ radosgw-admin user create --uid="summerKing" --display-name="summerKing" --access-key=q88888888 --secret=q88888888 --op_mask=read,write,delete --email=qwe@qq.com
could not create user: unable to parse parameters, user id mismatch, operation id: TTTT does not match: summerKing
```
新建的用户不能用已有的key，也不能使用相同的email





## win使用s3客户端工具

`CloudBerry Explorer for Amazon S3`

`S3 Browser`

这里不再赘述


## linux使用s3cmd挂载


```
[root@summer ~]# rpm -qa |grep -i s3cmd
s3cmd-2.1.0-1.el7.noarch
[root@summer ~]# s3cmd --configure

Enter new values or accept defaults in brackets with Enter.
Refer to user manual for detailed description of all options.

Access key and Secret key are your identifiers for Amazon S3. Leave them empty for using the env variables.
Access Key [w1234567]: q123456123456
Secret Key [w1234567]: q123456123456
Default Region [US]:  # 回车

Use "s3.amazonaws.com" for S3 Endpoint and not modify it to the target Amazon S3.
S3 Endpoint [192.168.163.200:8080]: # 主机 IP 地址:端口号

Use "%(bucket)s.s3.amazonaws.com" to the target Amazon S3. "%(bucket)s" and "%(location)s" vars can be used
if the target S3 system supports dns based buckets.
DNS-style bucket+hostname:port template for accessing a bucket [192.168.163.200:8080]:  主机的 IP 地址:端口号/bucket 名字

Encryption password is used to protect your files from reading
by unauthorized persons while in transfer to S3
Encryption password:  # 这里回车
Path to GPG program [/usr/bin/gpg]:  # 这里回车

When using secure HTTPS protocol all communication with Amazon S3
servers is protected from 3rd party eavesdropping. This method is
slower than plain HTTP, and can only be proxied with Python 2.7 or newer
Use HTTPS protocol [No]: no

On some networks all internet access must go through a HTTP proxy.
Try setting it here if you can't connect to S3 directly
HTTP Proxy server name: # 这里回车

New settings:
  Access Key: q123456123456
  Secret Key: q123456123456
  Default Region: US
  S3 Endpoint: 192.168.163.200:8080
  DNS-style bucket+hostname:port template for accessing a bucket: 192.168.163.200:8080
  Encryption password: 
  Path to GPG program: /usr/bin/gpg
  Use HTTPS protocol: False
  HTTP Proxy server name: 
  HTTP Proxy server port: 0

Test access with supplied credentials? [Y/n] n

Save settings? [y/N] yes
Configuration saved to '/root/.s3cfg'
```

> 技巧：这里其实可以一路回车，然后直接更改最终生成的`/root/.s3cfg`文件即可

### 创建桶

```
root in summer in ~ via 🐍 v2.7.5 
➜ s3cmd mb s3://test-bucket
Bucket 's3://test-bucket/' created
```

### 删除桶
- 删除空桶
```
root in summer in /home via 🐍 v2.7.5 
➜ s3cmd rb s3://new-bucket
ERROR: S3 error: 409 (BucketNotEmpty)
root in summer in /home via 🐍 v2.7.5 
❯ s3cmd del s3://new-bucket/s3test.py
delete: 's3://new-bucket/s3test.py'
root in summer in /home via 🐍 v2.7.5 
➜ s3cmd rb s3://new-bucket
Bucket 's3://new-bucket/' removed
root in summer in /home via 🐍 v2.7.5 
➜
```



### 上传文件至桶

```
root in summer in ~ via 🐍 v2.7.5 
➜ s3cmd put s3test.py s3://new-bucket
upload: 's3test.py' -> 's3://new-bucket/s3test.py'  [1 of 1]
 525 of 525   100% in    0s    15.01 KB/s  done
```


### 下载文件到本地

```
root in summer in /home 
❯ s3cmd get s3://new-bucket/s3test.py
download: 's3://new-bucket/s3test.py' -> './s3test.py'  [1 of 1]
 525 of 525   100% in    0s     9.46 KB/s  done
```


### 删除桶里的文件

```
root in summer in /home via 🐍 v2.7.5 
➜ s3cmd del s3://new-bucket/s3test.py
delete: 's3://new-bucket/s3test.py'
root in summer in /home via 🐍 v2.7.5 
➜ s3cmd ls s3://new-bucket
root in summer in /home via 🐍 v2.7.5 
➜
```



## 问题

- 创建桶报错：
```
root in summer in /home/test/ko_dir took 1m6s 
➜ s3cmd ls
2021-05-08 02:12  s3://eee
2021-05-08 04:28  s3://wy_test
root in summer in /home/test/ko_dir 
➜ s3cmd mb s3://new-bucket
ERROR: S3 error: 403 (InvalidAccessKeyId): The AWS Access Key Id you provided does not exist in our records.
```
- 查看配置

> 原来默认配置是访问到 s3.amazonaws.com 

```
root in summer in /home/test/ko_dir 
❯ cat  ~/.s3cfg  | grep host_bucket
host_bucket = %(bucket)s.s3.amazonaws.com
root in summer in /home/test/ko_dir 
➜
```

- 解决办法如下：


```
root in summer in /home/test/ko_dir 
➜ s3cmd mb s3://new-bucket
ERROR: S3 error: 403 (InvalidAccessKeyId): The AWS Access Key Id you provided does not exist in our records.
root in summer in /home/test/ko_dir 
❯ cat  ~/.s3cfg  | grep host_bucket
host_bucket = %(bucket)s.s3.amazonaws.com
root in summer in /home/test/ko_dir 
➜ vim   ~/.s3cfg  
root in summer in /home/test/ko_dir took 33s 
➜ s3cmd ls
2021-05-08 02:12  s3://eee
2021-05-08 04:28  s3://wy_test
root in summer in /home/test/ko_dir 
➜ s3cmd mb s3://new-bucket
Bucket 's3://new-bucket/' created
root in summer in /home/test/ko_dir 
➜ cat  ~/.s3cfg  | grep host_bucket
host_bucket = 192.168.150.11:8080/%(bucket)
root in summer in /home/test/ko_dir 
➜
```


- 上传文件至桶报错


```
root in summer in ~ via 🐍 v2.7.5 
➜ s3cmd put s3test.py s3://new-bucket
upload: 's3test.py' -> 's3://new-bucket/s3test.py'  [1 of 1]
 525 of 525   100% in    0s    74.23 KB/s  done
ERROR: S3 error: 403 (QuotaExceeded)
```

> 桶的配额超了，检查配额配置！！！