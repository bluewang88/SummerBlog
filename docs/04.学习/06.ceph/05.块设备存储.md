---
title: 块设备存储
date: 2021-03-30 14:40:19
permalink: /pages/716e4b/
categories:
  - 学习
  - ceph
tags:
  - 
---



块是一个字节序列（例如，一个 512 字节的数据块）。基于块的存储接口是最常见的存储数据方法，它们基于旋转介质，像硬盘、 CD 、软盘、甚至传统的 9 磁道磁带。无处不在的块设备接口使虚拟块设备成为与 Ceph 这样的海量存储系统交互的理想之选。

<!-- more -->








# RBD介绍

> RBD即RADOS Block Device的简称，RBD块存储是最稳定且最常用的存储类型。RBD块设备类似磁盘可以被挂载。 RBD块设备具有快照、多副本、克隆和一致性等特性，数据以条带化的方式存储在Ceph集群的多个OSD中。


注意: Ceph 中刚创建出来的块是不占空间，今后用多大空间，才会在 Ceph 中占用多大空间。
 
块存储本质就是将裸磁盘或类似裸磁盘(lvm)设备映射给主机使用，主机可以对其进行格式化并存储和读取数据，块设备读取速度快但是不支持共享。

ceph可以通过内核模块和librbd库提供块设备支持。客户端可以通过内核模块挂在rbd使用，客户端使用rbd块设备就像使用普通硬盘一样，可以对其就行格式化然后使用；客户应用也可以通过librbd使用ceph块，典型的是云平台的块存储服务，云平台可以使用rbd作为云的存储后端提供镜像存储、volume块或者客户的系统引导盘等。
 

# RBD常用命令
| 命令 | 功能 | 
| ------ | ------ | 
| rbd create | 创建块设备映像 | 
| rbd ls  | 列出 rbd 存储池中的块设备 | 
| rbd info  | 查看块设备信息 |
| rbd diff  | 可以统计 rbd 使用量 |
| rbd map  | 映射块设备 |
| rbd showmapped  | 查看已映射块设备 |
| rbd remove  | 删除块设备 |
| rbd resize  | 更改块设备的大小 |


## 块设备
### 创建快设备
```
root in summer in ~ via 🐍 v2.7.5 
➜ rbd create --size 1024 r-_k38-brp-468502291271118213827/lalala
root in summer in ~ via 🐍 v2.7.5 
➜ rbd -p r-_k38-brp-468502291271118213827 ls
lalala
root in summer in ~ via 🐍 v2.7.5 
➜ rbd ls r-_k38-brp-468502291271118213827
lalala
```


### 扩容块设备
- Ceph 块设备映像是精简配置，只有在你开始写入数据时它们才会占用物理空间。然而，它们都有最大容量，就是你设置的 --size 选项。



```
root in summer in ~ via 🐍 v2.7.5 
❯ rbd info r-_k38-brp-468502291271118213827/lalala
rbd image 'lalala':
        size 1024 MB in 256 objects
        order 22 (4096 kB objects)
        block_name_prefix: rbd_data.eb6f6b8b4567
        format: 2
        timestamp: 2021-05-08 16:53:33
        features: layering
        flags: 
root in summer in ~ via 🐍 v2.7.5 
➜ rbd resize  --size 2048 r-_k38-brp-468502291271118213827/lalala
Resizing image: 100% complete...done.
root in summer in ~ via 🐍 v2.7.5 
➜ rbd info r-_k38-brp-468502291271118213827/lalala
rbd image 'lalala':
        size 2048 MB in 512 objects
        order 22 (4096 kB objects)
        block_name_prefix: rbd_data.eb6f6b8b4567
        format: 2
        timestamp: 2021-05-08 16:53:33
        features: layering
        flags:
```

### 移动块设备
- 原理其实就是快照的克隆
- 例子：我想把池`r-_k38-brp-468502291271118213827`中的块`lalala`移动到池`r-_k38-brp-070813431311014473975`中

```
root in summer in ~ via 🐍 v2.7.5 
➜ rados lspools
r-_k60sysmag000
r-_k38-brp-468502291271118213827
r-_k60sysmag001
r-_k38-brp-070813431311014473975
```

```
root in summer in ~ via 🐍 v2.7.5 
❯ rbd ls r-_k38-brp-468502291271118213827
lalala
root in summer in ~ via 🐍 v2.7.5 
➜ rbd ls r-_k38-brp-070813431311014473975
r-_k38-307-101777431315714916604
root in summer in ~ via 🐍 v2.7.5 
➜ rbd snap ls r-_k38-brp-468502291271118213827/lalala
SNAPID NAME          SIZE 
    18 lalalasnap 2048 MB 
```

```
root in summer in ~ via 🐍 v2.7.5 
➜ rbd clone r-_k38-brp-468502291271118213827/lalala@lalalasnap r-_k38-brp-070813431311014473975/newmewlalala
2021-05-11 15:43:21.973634 7f141be22900 -1 librbd: parent snapshot must be protected
rbd: clone error: (22) Invalid argument
root in summer in ~ via 🐍 v2.7.5 
❯ rbd snap protect r-_k38-brp-468502291271118213827/lalala@lalalasnap
root in summer in ~ via 🐍 v2.7.5 
➜ rbd clone r-_k38-brp-468502291271118213827/lalala@lalalasnap r-_k38-brp-070813431311014473975/lalala
root in summer in ~ via 🐍 v2.7.5 
➜ rbd ls r-_k38-brp-070813431311014473975
lalala
r-_k38-307-101777431315714916604
root in summer in ~ via 🐍 v2.7.5 
➜ rbd ls r-_k38-brp-468502291271118213827
lalala
```



### 查看块设备


```
root in summer in ~ via 🐍 v2.7.5 
❯ rbd info r-_k38-brp-468502291271118213827/lalala
rbd image 'lalala':
        size 1024 MB in 256 objects
        order 22 (4096 kB objects)
        block_name_prefix: rbd_data.e93a6b8b4567
        format: 2
        timestamp: 2021-05-08 16:38:21
        features: layering
        flags:
```

### 使用块设备

#### 映射rbd到本地客户端
```
root in summer in ~ via 🐍 v2.7.5 
➜ rbd showmapped
root in summer in ~ via 🐍 v2.7.5 
➜ rbd map --image r-_k38-brp-468502291271118213827/lalala
/dev/cephrbd0
root in summer in ~ via 🐍 v2.7.5 
➜ rbd showmapped
id pool                             image  snap device        
0  r-_k38-brp-468502291271118213827 lalala -    /dev/cephrbd0 
```

#### 直接lsblk查看
```
root in summer in ~ via 🐍 v2.7.5 
➜ lsblk
NAME        MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT
sda           8:0    0  100G  0 disk 
├─sda1        8:1    0    1G  0 part /boot
├─sda2        8:2    0    5G  0 part /usr/sysmag_vfs
└─sda3        8:3    0   94G  0 part 
  └─os-root 253:0    0   94G  0 lvm  /
sdb           8:16   0   30G  0 disk 
└─sdb1        8:17   0   30G  0 part /var/lib/ceph/osd/ceph-0
sdc           8:32   0   30G  0 disk 
└─sdc1        8:33   0   30G  0 part /var/lib/ceph/osd/ceph-1
sr0          11:0    1  3.9G  0 rom  
cephrbd0    252:0    0    2G  0 disk 
```

#### 格式化该设备
```
root in summer in ~ via 🐍 v2.7.5 
➜ mkfs.xfs /dev/cephrbd0
log stripe unit (4194304 bytes) is too large (maximum is 256KiB)
log stripe unit adjusted to 32KiB
meta-data=/dev/cephrbd0          isize=256    agcount=8, agsize=65536 blks
         =                       sectsz=512   attr=2, projid32bit=1
         =                       crc=0        finobt=0, sparse=0, rmapbt=0, reflink=0
data     =                       bsize=4096   blocks=524288, imaxpct=25
         =                       sunit=1024   swidth=1024 blks
naming   =version 2              bsize=4096   ascii-ci=0 ftype=1
log      =internal log           bsize=4096   blocks=2560, version=2
         =                       sectsz=512   sunit=8 blks, lazy-count=1
realtime =none                   extsz=4096   blocks=0, rtextents=0
```

#### 挂载该设备
```
root in summer in ~ via 🐍 v2.7.5 took 4s 
➜ mkdir /rbdtest
root in summer in ~ via 🐍 v2.7.5 
❯ mount /dev/cephrbd0 /rbdtest/
root in summer in ~ via 🐍 v2.7.5 
➜ df -h
Filesystem           Size  Used Avail Use% Mounted on
devtmpfs             1.7G     0  1.7G   0% /dev
tmpfs                1.7G   20K  1.7G   1% /dev/shm
tmpfs                1.7G  103M  1.6G   6% /run
tmpfs                1.7G     0  1.7G   0% /sys/fs/cgroup
/dev/mapper/os-root   93G   23G   66G  26% /
/dev/sda1            976M  359M  551M  40% /boot
/dev/sda2            4.8G  696M  3.9G  15% /usr/sysmag_vfs
tmpfs                344M     0  344M   0% /run/user/1000
tmpfs                344M     0  344M   0% /run/user/0
/dev/sdb1             30G   21G  9.9G  68% /var/lib/ceph/osd/ceph-0
/dev/sdc1             30G   21G  9.9G  68% /var/lib/ceph/osd/ceph-1
/dev/cephrbd0        2.0G   33M  2.0G   2% /rbdtest
```

#### 卸载并取消块设备映射

```
root in summer in /rbdtest 
❯ umount -l /rbdtest
root in summer in ~ via 🐍 v2.7.5 
❯ rbd unmap /dev/rbd/r-_k38-brp-468502291271118213827/lalala
root in summer in ~ via 🐍 v2.7.5 
➜ rbd showmapped
root in summer in ~ via 🐍 v2.7.5 
➜ 
```

### 删除块设备

```
root in summer in ~ via 🐍 v2.7.5 
➜ rbd rm r-_k38-brp-468502291271118213827/lalala
Removing image: 100% complete...done.
```

#### 实时删除

#### 延时删除

- 块信息
```
root in summer in ~ via 🐍 v2.7.5 took 20s 
❯ rbd ls r-_k38-brp-468502291271118213827
lalala
newlalala
r-_k38-617-942223241315910956429
r-_k38-808-247448291273718198373
root in summer in ~ via 🐍 v2.7.5 
➜ rbd info r-_k38-brp-468502291271118213827/r-_k38-617-942223241315910956429
rbd image 'r-_k38-617-942223241315910956429':
        size 4096 MB in 1024 objects
        order 22 (4096 kB objects)
        block_name_prefix: rbd_data.32fb66b8b4567
        format: 2
        timestamp: 2021-05-11 10:25:05
        features: layering
        flags:
```

- 步骤

1. 重命名
```
rbd rename r-_k38-brp-468502291271118213827/r-_k38-617-942223241315910956429 r-_k38-brp-468502291271118213827/r-_k38-617-942223241315910956429_-sysmag-del
```

2. 查看快照
```
rbd snap ls r-_k38-brp-468502291271118213827/r-_k38-617-942223241315910956429_-sysmag-del | /bin/grep  -v 'SIZE' | /usr/bin/awk   '{print $2}'
```

3. 查看block_name_prefix
```
rbd -p r-_k38-brp-468502291271118213827 info r-_k38-617-942223241315910956429_-sysmag-del | /bin/grep  block_name_prefix | /usr/bin/awk  -F. '{print $2}'
```

4. 删除对象名称

```
rados -p r-_k38-brp-468502291271118213827 rm rbd_id.r-_k38-617-942223241315910956429_-sysmag-del

rados -p r-_k38-brp-468502291271118213827 rm rbd_header.32fb66b8b4567
```

5. 从对象名称的对象图中删除键

```
rados -p r-_k38-brp-468502291271118213827 rmomapkey rbd_directory id_32fb66b8b4567

rados -p r-_k38-brp-468502291271118213827 rmomapkey rbd_directory name_r-_k38-617-942223241315910956429_-sysmag-del
```




#### 删除到回收站

- 问题：rbd -h 没有trash命令？

```
root in summer in ~ via 🐍 v2.7.5 
➜ rbd  ls r-_k38-brp-468502291271118213827
lalala
newlalala
r-_k38-112-507157311312609997653
r-_k38-808-247448291273718198373
root in summer in ~ via 🐍 v2.7.5 
➜ rbd trash move r-_k38-112-507157311312609997653 -p r-_k38-brp-468502291271118213827
rbd: error parsing command 'trash'; -h or --help for usage
```
- 原来公司用的老版本不支持trash，只是页面上的删除到了回收站而已


## 快照
### 创建快照

```
root in summer in ~ via 🐍 v2.7.5 
➜ rbd ls r-_k38-brp-468502291271118213827
lalala
root in summer in ~ via 🐍 v2.7.5 
➜ rbd snap create --snap lalalasnap r-_k38-brp-468502291271118213827/lalala
```



### 查看快照
- `rbd snap ls {poolname}/{rbdname}`

```
root in summer in ~ via 🐍 v2.7.5 
➜ rbd snap ls r-_k38-brp-468502291271118213827/lalala
SNAPID NAME          SIZE 
     4 lalalasnap 2048 MB
```

### 保护快照

- 克隆映像要访问父快照。如果用户不小心删除了父快照，所有克隆映像都会损坏。为防止数据丢失，在克隆前必须先保护快照。
- 你删除不了受保护的快照。

```
root in summer in ~ via 🐍 v2.7.5 
➜ rbd snap protect r-_k38-brp-468502291271118213827/lalala@lalalasnap
```

### 克隆快照

```
root in summer in ~ via 🐍 v2.7.5 
➜ rbd clone r-_k38-brp-468502291271118213827/lalala@lalalasnap r-_k38-brp-468502291271118213827/newlalala
root in summer in ~ via 🐍 v2.7.5 
➜ rbd ls r-_k38-brp-468502291271118213827
lalala
newlalala
r-_k38-808-247448291273718198373
```

### 拍平克隆映像
- 如果映像是个克隆，就从父快照拷贝所有共享的块，使子快照独立于父快照，切断父子快照间的联系。如果没有克隆映像引用此父快照了，就可以取消保护并删除它。

```
root in summer in ~ via 🐍 v2.7.5 
❯ rbd flatten r-_k38-brp-468502291271118213827/newlalala
Image flatten: 100% complete...done.
```

### 取消快照保护

```
root in summer in ~ via 🐍 v2.7.5 
➜ rbd snap unprotect r-_k38-brp-468502291271118213827/lalala@lalalasnap
```


### 回滚快照

- `rbd snap rollback {pool-name}/{image-name}@{snap-name}`

```
root in summer in ~ via 🐍 v2.7.5 
➜ rbd snap rollback r-_k38-brp-468502291271118213827/lalala@lalalasnap
Rolling back to snapshot: 100% complete...done.
```

### 删除快照

- `rbd snap rm {pool-name}/{image-name}@{snap-name}`


```
root in summer in ~ via 🐍 v2.7.5 
➜ rbd snap rm r-_k38-brp-468502291271118213827/lalala@lalalasnap
```

### 清除快照


```
root in summer in ~ via 🐍 v2.7.5 
❯ rbd snap ls r-_k38-brp-468502291271118213827/r-_k38-808-247448291273718198373
SNAPID NAME                              SIZE 
     8 r-_k38-m-044519291302109417845 1024 MB 
     9 r-_k38-m-803818301304009172794 1024 MB 
    10 r-_k38-m-924936321301809791366 1024 MB 
root in summer in ~ via 🐍 v2.7.5 
➜ 
root in summer in ~ via 🐍 v2.7.5 
➜ rbd snap purge r-_k38-brp-468502291271118213827/r-_k38-808-247448291273718198373
Removing all snapshots: 100% complete...done.
root in summer in ~ via 🐍 v2.7.5 took 18s 
➜ rbd snap ls r-_k38-brp-468502291271118213827/r-_k38-808-247448291273718198373
root in summer in ~ via 🐍 v2.7.5 
➜
```
